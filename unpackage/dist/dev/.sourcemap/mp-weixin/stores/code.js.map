{"version":3,"file":"code.js","sources":["stores/code.ts"],"sourcesContent":["import { defineStore } from 'pinia';\r\nimport sanitizeHtml from 'sanitize-html';\r\nimport { request } from '../server'\r\nimport { CodeItem } from '../typings'\r\nimport { apiUrl } from '../constant'\r\n\r\ninterface IProps {\r\n\tpageNo : number,\r\n\tpageSize : number,\r\n\ttotal : number,\r\n\tloading : boolean,\r\n\tcodeList : CodeItem[],\r\n\tdetail : Partial<CodeItem>,\r\n\tdetailLoading : boolean,\r\n\thtml : string\r\n}\r\n\r\nexport const useCodeStore = defineStore('code', {\r\n\tstate: () : IProps => ({\r\n\t\tpageNo: 0,\r\n\t\tpageSize: 20,\r\n\t\ttotal: 0,\r\n\t\tloading: false,\r\n\t\tcodeList: [],\r\n\t\tdetail: {},\r\n\t\tdetailLoading: false,\r\n\t\thtml: ''\r\n\t}),\r\n\tactions: {\r\n\t\tinit() {\r\n\t\t\tthis.pageNo = 0\r\n\t\t\tthis.pageSize = 20\r\n\t\t\tthis.total = 0\r\n\t\t\tthis.codeList = []\r\n\t\t},\r\n\t\tasync getCodeList(keyword ?: string, langType ?: string) {\r\n\t\t\ttry {\r\n\t\t\t\tif (this.codeList.length !== 0 && this.codeList.length >= this.total) return;\r\n\t\t\t\tthis.pageNo = this.pageNo + 1;\r\n\t\t\t\tthis.loading = true\r\n\t\t\t\tconst res = await request<{ data : { list : CodeItem[], total : number }, success : boolean }>({\r\n\t\t\t\t\turl: `${apiUrl}/getCodeListByMiniProgram`,\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tpageNo: this.pageNo,\r\n\t\t\t\t\t\tpageSize: this.pageSize,\r\n\t\t\t\t\t\tkeyword,\r\n\t\t\t\t\t\tlangType,\r\n\t\t\t\t\t\tall: true\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tthis.loading = false;\r\n\t\t\t\tif (res?.success) {\r\n\t\t\t\t\tthis.total = res.data.total;\r\n\t\t\t\t\tthis.codeList = [...this.codeList, ...res.data.list];\r\n\t\t\t\t}\r\n\t\t\t} catch {\r\n\t\t\t\tthis.loading = false\r\n\t\t\t}\r\n\t\t},\r\n\t\tasync getCodeById(id : string) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.detailLoading = true;\r\n\t\t\t\tconst res = await request<{ data : CodeItem, success : boolean }>({\r\n\t\t\t\t\turl: `${apiUrl}/getCodeByIdByMiniProgram`,\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tid\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tif (res.success) {\r\n\t\t\t\t\tthis.detail = res.data\r\n\t\t\t\t\tconst result = await request<{ data : string, success : boolean }>({\r\n\t\t\t\t\t\turl: `${apiUrl}/md2html`,\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\tcontent: `\\`\\`\\`${res.data.language}\\n${res.data.content}\\n\\`\\`\\``,\r\n\t\t\t\t\t\t\toptions: {\r\n\t\t\t\t\t\t\t\tneedKatex: false, // 是否需要转译数学公式\r\n\t\t\t\t\t\t\t\tlineNumber: true // 是否开启代码块行号\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\tthis.detailLoading = false;\r\n\t\t\t\t\tif (result.success) {\r\n\t\t\t\t\t\tconst cleanHtml = sanitizeHtml(result.data, {\r\n\t\t\t\t\t\t\tallowedTags: false,\r\n\t\t\t\t\t\t\ttransformTags: {\r\n\t\t\t\t\t\t\t\tiframe: 'div',\r\n\t\t\t\t\t\t\t\tscript: 'p',\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tallowedAttributes: false,\r\n\t\t\t\t\t\t\tallowVulnerableTags: true, // 明确允许危险标签\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tthis.html = cleanHtml\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.html = ''\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.detailLoading = false;\r\n\t\t\t\t}\r\n\t\t\t} catch {\r\n\t\t\t\tthis.detailLoading = false\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n});"],"names":["defineStore","request","apiUrl","sanitizeHtml"],"mappings":";;;;AAiBa,MAAA,eAAeA,0BAAY,QAAQ;AAAA,EAC/C,OAAO,OAAgB;AAAA,IACtB,QAAQ;AAAA,IACR,UAAU;AAAA,IACV,OAAO;AAAA,IACP,SAAS;AAAA,IACT,UAAU,CAAC;AAAA,IACX,QAAQ,CAAC;AAAA,IACT,eAAe;AAAA,IACf,MAAM;AAAA,EAAA;AAAA,EAEP,SAAS;AAAA,IACR,OAAO;AACN,WAAK,SAAS;AACd,WAAK,WAAW;AAChB,WAAK,QAAQ;AACb,WAAK,WAAW;IACjB;AAAA,IACA,MAAM,YAAY,SAAmB,UAAoB;AACpD,UAAA;AACH,YAAI,KAAK,SAAS,WAAW,KAAK,KAAK,SAAS,UAAU,KAAK;AAAO;AACjE,aAAA,SAAS,KAAK,SAAS;AAC5B,aAAK,UAAU;AACT,cAAA,MAAM,MAAMC,qBAA6E;AAAA,UAC9F,KAAK,GAAGC,eAAM,MAAA;AAAA,UACd,MAAM;AAAA,YACL,QAAQ,KAAK;AAAA,YACb,UAAU,KAAK;AAAA,YACf;AAAA,YACA;AAAA,YACA,KAAK;AAAA,UACN;AAAA,QAAA,CACA;AACD,aAAK,UAAU;AACf,YAAI,2BAAK,SAAS;AACZ,eAAA,QAAQ,IAAI,KAAK;AACjB,eAAA,WAAW,CAAC,GAAG,KAAK,UAAU,GAAG,IAAI,KAAK,IAAI;AAAA,QACpD;AAAA,MAAA,QACO;AACP,aAAK,UAAU;AAAA,MAChB;AAAA,IACD;AAAA,IACA,MAAM,YAAY,IAAa;AAC1B,UAAA;AACH,aAAK,gBAAgB;AACf,cAAA,MAAM,MAAMD,qBAAgD;AAAA,UACjE,KAAK,GAAGC,eAAM,MAAA;AAAA,UACd,MAAM;AAAA,YACL;AAAA,UACD;AAAA,QAAA,CACA;AACD,YAAI,IAAI,SAAS;AAChB,eAAK,SAAS,IAAI;AACZ,gBAAA,SAAS,MAAMD,qBAA8C;AAAA,YAClE,KAAK,GAAGC,eAAM,MAAA;AAAA,YACd,MAAM;AAAA,cACL,SAAS,SAAS,IAAI,KAAK,QAAQ;AAAA,EAAK,IAAI,KAAK,OAAO;AAAA;AAAA,cACxD,SAAS;AAAA,gBACR,WAAW;AAAA;AAAA,gBACX,YAAY;AAAA;AAAA,cACb;AAAA,YACD;AAAA,UAAA,CACA;AACD,eAAK,gBAAgB;AACrB,cAAI,OAAO,SAAS;AACb,kBAAA,YAAYC,cAAAA,aAAa,OAAO,MAAM;AAAA,cAC3C,aAAa;AAAA,cACb,eAAe;AAAA,gBACd,QAAQ;AAAA,gBACR,QAAQ;AAAA,cACT;AAAA,cACA,mBAAmB;AAAA,cACnB,qBAAqB;AAAA;AAAA,YAAA,CACrB;AACD,iBAAK,OAAO;AAAA,UAAA,OACN;AACN,iBAAK,OAAO;AAAA,UACb;AAAA,QAAA,OACM;AACN,eAAK,gBAAgB;AAAA,QACtB;AAAA,MAAA,QACO;AACP,aAAK,gBAAgB;AAAA,MACtB;AAAA,IACD;AAAA,EACD;AACD,CAAC;;"}