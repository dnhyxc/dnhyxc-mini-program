{"version":3,"file":"index.js","sources":["wxcomponents/towxml/parse/parse2/domhandler/index.js"],"sourcesContent":["var domelementtype_1 = require(\"../domelementtype/index.js\");\nvar node_js_1 = require(\"./node.js\");\nvar defaultOpts = {\n    withStartIndices: false,\n    withEndIndices: false,\n    xmlMode: false,\n};\nvar DomHandler = /** @class */ (function () {\n    /**\n     * @param callback Called once parsing has completed.\n     * @param options Settings for the handler.\n     * @param elementCB Callback whenever a tag is closed.\n     */\n    function DomHandler(callback, options, elementCB) {\n        /** The elements of the DOM */\n        this.dom = [];\n        /** The root element for the DOM */\n        this.root = new node_js_1.Document(this.dom);\n        /** Indicated whether parsing has been completed. */\n        this.done = false;\n        /** Stack of open tags. */\n        this.tagStack = [this.root];\n        /** A data node that is still being written to. */\n        this.lastNode = null;\n        /** Reference to the parser instance. Used for location information. */\n        this.parser = null;\n        // Make it possible to skip arguments, for backwards-compatibility\n        if (typeof options === \"function\") {\n            elementCB = options;\n            options = defaultOpts;\n        }\n        if (typeof callback === \"object\") {\n            options = callback;\n            callback = undefined;\n        }\n        this.callback = callback !== null && callback !== void 0 ? callback : null;\n        this.options = options !== null && options !== void 0 ? options : defaultOpts;\n        this.elementCB = elementCB !== null && elementCB !== void 0 ? elementCB : null;\n    }\n    DomHandler.prototype.onparserinit = function (parser) {\n        this.parser = parser;\n    };\n    // Resets the handler back to starting state\n    DomHandler.prototype.onreset = function () {\n        this.dom = [];\n        this.root = new node_js_1.Document(this.dom);\n        this.done = false;\n        this.tagStack = [this.root];\n        this.lastNode = null;\n        this.parser = null;\n    };\n    // Signals the handler that parsing is done\n    DomHandler.prototype.onend = function () {\n        if (this.done)\n            return;\n        this.done = true;\n        this.parser = null;\n        this.handleCallback(null);\n    };\n    DomHandler.prototype.onerror = function (error) {\n        this.handleCallback(error);\n    };\n    DomHandler.prototype.onclosetag = function () {\n        this.lastNode = null;\n        var elem = this.tagStack.pop();\n        if (this.options.withEndIndices) {\n            elem.endIndex = this.parser.endIndex;\n        }\n        if (this.elementCB)\n            this.elementCB(elem);\n    };\n    DomHandler.prototype.onopentag = function (name, attribs) {\n        var type = this.options.xmlMode ? domelementtype_1.ElementType.Tag : undefined;\n        var element = new node_js_1.Element(name, attribs, undefined, type);\n        this.addNode(element);\n        this.tagStack.push(element);\n    };\n    DomHandler.prototype.ontext = function (data) {\n        var lastNode = this.lastNode;\n        if (lastNode && lastNode.type === domelementtype_1.ElementType.Text) {\n            lastNode.data += data;\n            if (this.options.withEndIndices) {\n                lastNode.endIndex = this.parser.endIndex;\n            }\n        }\n        else {\n            var node = new node_js_1.Text(data);\n            this.addNode(node);\n            this.lastNode = node;\n        }\n    };\n    DomHandler.prototype.oncomment = function (data) {\n        if (this.lastNode && this.lastNode.type === domelementtype_1.ElementType.Comment) {\n            this.lastNode.data += data;\n            return;\n        }\n        var node = new node_js_1.Comment(data);\n        this.addNode(node);\n        this.lastNode = node;\n    };\n    DomHandler.prototype.oncommentend = function () {\n        this.lastNode = null;\n    };\n    DomHandler.prototype.oncdatastart = function () {\n        var text = new node_js_1.Text(\"\");\n        var node = new node_js_1.CDATA([text]);\n        this.addNode(node);\n        text.parent = node;\n        this.lastNode = text;\n    };\n    DomHandler.prototype.oncdataend = function () {\n        this.lastNode = null;\n    };\n    DomHandler.prototype.onprocessinginstruction = function (name, data) {\n        var node = new node_js_1.ProcessingInstruction(name, data);\n        this.addNode(node);\n    };\n    DomHandler.prototype.handleCallback = function (error) {\n        if (typeof this.callback === \"function\") {\n            this.callback(error, this.dom);\n        }\n        else if (error) {\n            throw error;\n        }\n    };\n    DomHandler.prototype.addNode = function (node) {\n        var parent = this.tagStack[this.tagStack.length - 1];\n        var previousSibling = parent.children[parent.children.length - 1];\n        if (this.options.withStartIndices) {\n            node.startIndex = this.parser.startIndex;\n        }\n        if (this.options.withEndIndices) {\n            node.endIndex = this.parser.endIndex;\n        }\n        parent.children.push(node);\n        if (previousSibling) {\n            node.prev = previousSibling;\n            previousSibling.next = node;\n        }\n        node.parent = parent;\n        this.lastNode = null;\n    };\n    return DomHandler;\n}());\nmodule.exports = DomHandler;"],"names":["require$$0","require$$1","DomHandler"],"mappings":"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"}