"use strict";const t=require("./parser.js");function e(){this.styles=[]}function s(t,e){function s(e){if("#"===e[0]){if(t.attrs.id&&t.attrs.id.trim()===e.substr(1))return 3}else if("."===e[0]){e=e.substr(1);const s=(t.attrs.class||"").split(" ");for(let t=0;t<s.length;t++)if(s[t].trim()===e)return 2}else if(t.name===e)return 1;return 0}if(e instanceof Array){let t=0;for(let r=0;r<e.length;r++){const l=s(e[r]);if(!l)return 0;l>t&&(t=l)}return t}return s(e)}e.prototype.onParse=function(e,r){if("style"===e.name&&e.children.length&&"text"===e.children[0].type)this.styles=this.styles.concat((new t.Parser).parse(e.children[0].text));else if(e.name){let t=["","","",""];for(let l=0,n=this.styles.length;l<n;l++){const n=this.styles[l];let i,a=s(e,n.key||n.list[n.list.length-1]);if(a){if(!n.key){i=n.list.length-2;for(let t=r.stack.length;i>=0&&t--;)if(">"===n.list[i]){if(i<1||i>n.list.length-2)break;s(r.stack[t],n.list[i-1])?i-=2:i++}else s(r.stack[t],n.list[i])&&i--;a=4}if(n.key||i<0)if(n.pseudo&&e.children){let t;n.style=n.style.replace(/content:([^;]+)/,((s,r)=>(t=r.replace(/['"]/g,"").replace(/attr\((.+?)\)/,((t,s)=>e.attrs[s.trim()]||"")).replace(/\\(\w{4})/,((t,e)=>String.fromCharCode(parseInt(e,16)))),"")));const s={name:"span",attrs:{style:n.style},children:[{type:"text",text:t}]};"before"===n.pseudo?e.children.unshift(s):e.children.push(s)}else t[a-1]+=n.style+(";"===n.style[n.style.length-1]?"":";")}}t=t.join(""),t.length>2&&(e.attrs.style=t+(e.attrs.style||""))}},exports.Style=e;
